<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Custom Radial Chart Generator</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 40px; }
    h2, h3 { text-align: center; }
    #chart { margin: 40px auto; max-width: 900px; }
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: center;
    }
    label { flex: 1 1 200px; }
    input[type="number"] { width: 60px; }
    #upload-section, #controls { text-align: center; margin-bottom: 20px; }
    #weights-section { margin: 20px auto; max-width: 1000px; }
    #scoreTable { margin: 20px auto; border-collapse: collapse; width: 80%; }
    #scoreTable th, #scoreTable td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    #exportBtn, #generateBtn {
      padding: 8px 16px;
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>Custom Radial Chart Generator</h2>

<div id="upload-section">
  <p><strong>Step 1:</strong> Upload your data file (.csv)</p>
  <input type="file" id="csvUpload" accept=".csv">
</div>

<div id="controls" style="display:none">
  <p><strong>Step 2:</strong> Choose an entry (e.g., census tract)</p>
  <select id="tractSelect"></select>
</div>

<div id="weights-section"></div>

<div id="generate-section" style="text-align: center; display: none;">
  <button id="generateBtn">Generate Chart</button>
</div>

<div id="chart"></div>

<div id="form-controls" style="text-align:center; margin-top: 20px;">
  <button id="exportBtn" style="display:none">Export High-Res PNG</button>
</div>

<h3>Score Table</h3>
<div id="scoreTableContainer">
  <table id="scoreTable"></table>
</div>

<script>
let parsedData = [];
let variableKeys = [];
let currentScores = [];
let labels = [];

document.getElementById('csvUpload').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;

  Papa.parse(file, {
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,
    complete: function (results) {
      parsedData = results.data;
      const fixedCols = ['Row', 'Source', 'CASRN', 'Name'];
      variableKeys = Object.keys(parsedData[0]).filter(key => !fixedCols.includes(key));
      labels = [...variableKeys]; // store for future use

      buildWeightInputs(variableKeys);
      populateDropdown(parsedData.map(row => row['Name']));
      document.getElementById('controls').style.display = 'block';
      document.getElementById('generate-section').style.display = 'block';
      document.getElementById('exportBtn').style.display = 'inline-block';
    }
  });
});

function buildWeightInputs(keys) {
  const container = document.getElementById('weights-section');
  container.innerHTML = '<h3>Step 3: Set Weights</h3><div class="input-row" id="weightInputs"></div>';
  const row = document.getElementById('weightInputs');
  keys.forEach(key => {
    const label = document.createElement('label');
    label.innerHTML = `${key} <input type="number" name="${key}" value="1" min="0" step="0.1"> %`;
    row.appendChild(label);
  });
}

function populateDropdown(names) {
  const select = document.getElementById('tractSelect');
  select.innerHTML = '';
  names.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.text = name;
    select.appendChild(opt);
  });
}

document.getElementById('generateBtn').addEventListener('click', function () {
  const selectedName = document.getElementById('tractSelect').value;
  const selectedRow = parsedData.find(row => row['Name'] == selectedName);
  if (!selectedRow) return;

  currentScores = variableKeys.map(key => parseFloat(selectedRow[key]) || 0);

  const formData = new FormData(document.getElementById('weightForm') || new HTMLFormElement());
  const weights = variableKeys.map(key => {
    const el = document.querySelector(`input[name="${key}"]`);
    return parseFloat(el?.value) || 0;
  });

  drawChart(weights, currentScores);
  buildScoreTable(variableKeys, currentScores, weights);
});

function drawChart(weights, scores) {
  const total = weights.reduce((sum, w) => sum + w, 0) || 1;
  const normWeights = weights.map(w => w / total);

  const traces = [];
  let startAngle = 0;
  const colors = Array.from({ length: weights.length }, (_, i) => `hsl(${i * 360 / weights.length},60%,60%)`);

  for (let i = 0; i < variableKeys.length; i++) {
    const angle = normWeights[i] * 360;
    const theta = [startAngle, startAngle, startAngle + angle, startAngle + angle];
    const r = [0, scores[i], scores[i], 0];

    traces.push({
      type: 'scatterpolar',
      mode: 'lines',
      r: r,
      theta: theta,
      fill: 'toself',
      fillcolor: colors[i],
      line: { width: 0 },
      hoverinfo: 'text',
      name: variableKeys[i],
      text: `${variableKeys[i]}<br>Score: ${scores[i]?.toFixed(2)}`,
      showlegend: false
    });

    startAngle += angle;
  }

  const layout = {
    polar: {
      radialaxis: { visible: true, range: [0, 1] },
      angularaxis: { direction: 'counterclockwise', rotation: 90 }
    },
    margin: { t: 30, b: 30, l: 30, r: 30 },
    width: 800,
    height: 800
  };

  Plotly.newPlot('chart', traces, layout);
}

function buildScoreTable(labels, scores, weights) {
  const table = document.getElementById('scoreTable');
  table.innerHTML = `<thead><tr><th>Variable</th><th>Score</th><th>Weight</th><th>Score Ã— Weight</th></tr></thead><tbody></tbody>`;
  const tbody = table.querySelector('tbody');

  let total = 0;
  for (let i = 0; i < labels.length; i++) {
    const row = document.createElement('tr');
    const weighted = scores[i] * weights[i];
    total += weighted;

    row.innerHTML = `<td>${labels[i]}</td><td>${scores[i]?.toFixed(3)}</td><td>${weights[i]}</td><td>${weighted.toFixed(3)}</td>`;
    tbody.appendChild(row);
  }

  const totalRow = document.createElement('tr');
  totalRow.innerHTML = `<td colspan="3"><strong>ToxPi Total</strong></td><td><strong>${total.toFixed(3)}</strong></td>`;
  tbody.appendChild(totalRow);
}

document.getElementById('exportBtn').addEventListener('click', () => {
  Plotly.toImage(document.getElementById('chart'), {
    format: 'png',
    width: 3300,
    height: 2550
  }).then(url => {
    const a = document.createElement('a');
    a.href = url;
    a.download = 'radial_chart.png';
    a.click();
  });
});
</script>
</body>
</html>
